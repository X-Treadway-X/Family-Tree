<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Family Tree v3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: #f2f2f2;
    overflow: hidden;
  }
  #controls {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 8px;
    z-index: 9999;
  }
  #controls button {
    margin: 2px;
    padding: 4px 8px;
    cursor: pointer;
  }
  #backgroundSelector {
    margin-left: 8px;
  }
  #zoomControls {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 8px;
    z-index: 9999;
  }
  #treeContainer {
    width: 100vw;
    height: 100vh;
    position: relative;
    overflow: hidden;
    transform-origin: 0 0;
  }
  .panel {
    position: absolute;
    width: 180px;
    min-height: 220px;
    background: #fff;
    border: 2px solid #333;
    border-radius: 10px;
    text-align: center;
    cursor: grab;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 5px;
    box-sizing: border-box;
  }
  .panel img {
    width: 60%;
    height: auto;
    border-radius: 50%;
    margin-bottom: 5px;
  }
  .panel input, .panel select {
    width: 90%;
    margin: 2px 0;
  }
  .panel button {
    margin: 2px;
    font-size: 12px;
    cursor: pointer;
  }
  .hoverCard {
    position: absolute;
    pointer-events: none;
    background: rgba(20,20,20,0.9);
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
    display: none;
    z-index: 9998;
    max-width: 200px;
    text-align: left;
    font-family: 'Inter', sans-serif;
  }
  svg.connector {
    position: absolute;
    top: 0;
    left: 0;
    overflow: visible;
    pointer-events: none;
  }
</style>
</head>
<body>

<div id="controls">
  <button onclick="addPerson()">Add Person</button>
  <button onclick="saveData()">Export Backup</button>
  <input type="file" id="importFile" />
  <button onclick="importData()">Import Backup</button>
  <label>Background: <input type="color" id="backgroundSelector" onchange="changeBackground(this.value)" value="#f2f2f2"></label>
</div>

<div id="zoomControls">
  <button onclick="zoom(1.2)">+</button>
  <button onclick="zoom(0.8)">-</button>
</div>

<div id="treeContainer"></div>
<div id="hoverCard" class="hoverCard"></div>
<svg id="connectorLayer" class="connector"></svg>

<script>
let treeData = JSON.parse(localStorage.getItem('familyTreeData')) || [];
let zoomLevel = 1;
const container = document.getElementById('treeContainer');
const connectorLayer = document.getElementById('connectorLayer');
const hoverCard = document.getElementById('hoverCard');

// --- Utility Functions ---
function saveData() {
  localStorage.setItem('familyTreeData', JSON.stringify(treeData));
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(treeData, null, 2));
  const dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  dlAnchor.setAttribute("download", "family_tree_backup.json");
  dlAnchor.click();
}

function importData() {
  const fileInput = document.getElementById('importFile');
  if (!fileInput.files[0]) return alert("Select a JSON file");
  const reader = new FileReader();
  reader.onload = e => {
    treeData = JSON.parse(e.target.result);
    renderTree();
    saveData();
  };
  reader.readAsText(fileInput.files[0]);
}

function changeBackground(color) {
  container.style.background = color;
}

// --- Zoom ---
function zoom(factor) {
  zoomLevel *= factor;
  container.style.transform = `scale(${zoomLevel})`;
}

// --- Person Management ---
function addPerson() {
  const id = Date.now();
  treeData.push({
    id, name: 'New Person', gender: 'Male', dob: '', dod: '', alive: true, notes:'', img:'',
    x: 100, y: 100, parentIds: [], spouseIds: [], mainFamily: false, personalFamily: false
  });
  renderTree();
  saveData();
}

function renderTree() {
  container.innerHTML = '';
  connectorLayer.innerHTML = '';
  treeData.forEach(p => createPanel(p));
  drawConnectors();
}

function createPanel(person) {
  const panel = document.createElement('div');
  panel.className = 'panel';
  panel.style.left = person.x + 'px';
  panel.style.top = person.y + 'px';

  const img = document.createElement('img');
  img.src = person.img || 'https://via.placeholder.com/100';
  panel.appendChild(img);

  const nameInput = document.createElement('input');
  nameInput.value = person.name;
  nameInput.oninput = e => { person.name = e.target.value; saveData(); };
  panel.appendChild(nameInput);

  const genderSelect = document.createElement('select');
  ['Male','Female'].forEach(g => {
    const opt = document.createElement('option'); opt.value=g; opt.text=g; genderSelect.appendChild(opt);
  });
  genderSelect.value = person.gender;
  genderSelect.onchange = e => { person.gender = e.target.value; saveData(); };
  panel.appendChild(genderSelect);

  // Date of Birth
  const dobInput = document.createElement('input');
  dobInput.type = 'date';
  dobInput.value = person.dob;
  dobInput.onchange = e => { person.dob = e.target.value; saveData(); };
  panel.appendChild(dobInput);

  // Date of Death
  const dodInput = document.createElement('input');
  dodInput.type = 'date';
  dodInput.value = person.dod;
  dodInput.onchange = e => { person.dod = e.target.value; saveData(); };
  panel.appendChild(dodInput);

  const aliveBtn = document.createElement('button');
  aliveBtn.textContent = person.alive ? 'Alive' : 'Deceased';
  aliveBtn.onclick = () => { person.alive = !person.alive; aliveBtn.textContent = person.alive?'Alive':'Deceased'; saveData(); };
  panel.appendChild(aliveBtn);

  const notesInput = document.createElement('input');
  notesInput.placeholder = 'Notes';
  notesInput.value = person.notes;
  notesInput.oninput = e => { person.notes = e.target.value; saveData(); };
  panel.appendChild(notesInput);

  const imgInput = document.createElement('input');
  imgInput.type = 'file';
  imgInput.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => { person.img = ev.target.result; img.src = ev.target.result; saveData(); };
    reader.readAsDataURL(file);
  };
  panel.appendChild(imgInput);

  // Move panel
  let offsetX, offsetY, dragging=false;
  panel.onmousedown = e => {
    dragging=true;
    offsetX=e.offsetX; offsetY=e.offsetY;
  };
  document.onmousemove = e => {
    if(!dragging) return;
    person.x = e.clientX - offsetX;
    person.y = e.clientY - offsetY;
    panel.style.left = person.x+'px';
    panel.style.top = person.y+'px';
    drawConnectors();
  };
  document.onmouseup = () => dragging=false;

  // Hover card
  panel.onmouseenter = e => {
    hoverCard.style.display='block';
    hoverCard.innerHTML = `<strong>${person.name}</strong><br>
      Gender: ${person.gender}<br>
      Alive: ${person.alive}<br>
      ${person.dob?('Born: '+formatDate(person.dob)+'<br>'):""}
      ${person.dod?('Died: '+formatDate(person.dod)+'<br>'):""}
      Notes: ${person.notes}<br>`;
  };
  panel.onmousemove = e => {
    hoverCard.style.left = (e.pageX+15)+'px';
    hoverCard.style.top = (e.pageY+15)+'px';
  };
  panel.onmouseleave = () => { hoverCard.style.display='none'; };

  container.appendChild(panel);
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  if(isNaN(d)) return '';
  return d.toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'});
}

// --- Connectors ---
function drawConnectors() {
  connectorLayer.innerHTML = '';
  treeData.forEach(p => {
    p.parentIds.forEach(pid => {
      const parent = treeData.find(x=>x.id===pid);
      if(!parent) return;
      const x1 = parent.x + 90, y1 = parent.y + 220;
      const x2 = p.x + 90, y2 = p.y;
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", `M${x1},${y1} C${x1},${(y1+y2)/2} ${x2},${(y1+y2)/2} ${x2},${y2}`);
      path.setAttribute("stroke","#333");
      path.setAttribute("fill","transparent");
      path.setAttribute("stroke-width","2");
      connectorLayer.appendChild(path);
    });
  });
}

// Initial render
renderTree();

</script>
</body>
</html>
