<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree App</title>
    <link rel="icon" href="assets/family-tree-favicon.png" type="image/png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #0a0a0a;
            overflow: hidden;
        }

        .tree-clock {
          position: absolute;
          top: 85px;
          right: 1250px;
          font-family: 'Georgia', serif;
          font-size: 14px;
          color: #fff;
          background: rgba(0,0,0,0.4);
          padding: 6px 12px;
          border-radius: 8px;
          box-shadow: 0 3px 8px rgba(0,0,0,0.4);
          letter-spacing: 1px;
          z-index: 10;
        }


        body.light-theme {
            background: #f5f5f5;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(135deg, #1a120d 0%, #0d0a08 100%);
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            padding: 0 30px;
            gap: 20px;
            z-index: 1000;
            border-bottom: 3px solid #8b4513;
        }

        body.light-theme #toolbar {
            background: linear-gradient(135deg, #8b6914 0%, #6b5410 100%);
            border-bottom: 3px solid #d4af37;
        }

        .toolbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-right: auto;
        }

        .toolbar-icon {
            font-size: 40px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
        }

        .toolbar-title {
            font-size: 28px;
            color: #d4af37;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        .toolbar-section {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .theme-selector {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            border: 2px solid #8b4513;
        }

        body.light-theme .theme-selector {
            background: rgba(255,255,255,0.4);
        }

        .theme-selector label {
            color: #d4af37;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        body.light-theme .theme-selector label {
            color: #2d1810;
        }

        .theme-selector select {
            padding: 6px 12px;
            border: 2px solid #8b4513;
            border-radius: 6px;
            background: rgba(0,0,0,0.6);
            color: #d4af37;
            font-family: Georgia, serif;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
        }

        body.light-theme .theme-selector select {
            background: rgba(255,255,255,0.9);
            color: #2d1810;
        }

        .zoom-controls {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            border: 2px solid #8b4513;
        }

        body.light-theme .zoom-controls {
            background: rgba(255,255,255,0.4);
        }

        .zoom-controls label {
            color: #d4af37;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        body.light-theme .zoom-controls label {
            color: #2d1810;
        }

        .zoom-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #8b4513;
            background: linear-gradient(135deg, #228b22 0%, #1a6b1a 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .zoom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(34, 139, 34, 0.6);
        }

        .zoom-btn:active {
            transform: translateY(0);
        }

        .zoom-level {
            color: #d4af37;
            font-size: 14px;
            font-weight: bold;
            min-width: 55px;
            text-align: center;
        }

        body.light-theme .zoom-level {
            color: #2d1810;
        }

        .btn {
            padding: 14px 24px;
            border: 2px solid transparent;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #228b22 0%, #1a6b1a 100%);
            color: #fff;
            border-color: #2fa02f;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2fa02f 0%, #228b22 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #8b6914 0%, #6b5410 100%);
            color: #fff;
            border-color: #a0791a;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #a0791a 0%, #8b6914 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #8b2500 0%, #6b1d00 100%);
            color: #fff;
            border-color: #a03000;
        }

        .btn.active {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #2d1810;
            border-color: #f4d03f;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(212, 175, 55, 0.6); }
            50% { box-shadow: 0 0 50px rgba(212, 175, 55, 0.8); }
        }

        #workspace {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            cursor: grab;
        }

        #workspace.panning {
            cursor: grabbing;
        }

        #workspace::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        #workspace::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        body.light-theme #workspace::-webkit-scrollbar-track {
            background: #e0e0e0;
        }

        #workspace::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 6px;
        }

        #canvasWrapper {
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        #canvas {
            position: relative;
            width: 4000px;
            height: 3000px;
            background: linear-gradient(180deg, #072012 0%, #0b3a1f 40%, #062816 100%);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(139, 69, 19, 0.05) 49px, rgba(139, 69, 19, 0.05) 50px),
                repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(139, 69, 19, 0.05) 49px, rgba(139, 69, 19, 0.05) 50px);
        }

        body.light-theme #canvas {
            background: linear-gradient(135deg, #f5f5dc 0%, #e8dcc0 100%);
        }

        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .node {
            position: absolute;
            width: 270px;
            min-height: 300px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.8), inset 0 2px 0 rgba(255,255,255,0.1);
            padding: 20px;
            cursor: move;
            transition: transform 0.3s, box-shadow 0.3s;
            z-index: 10;
            border: 4px solid;
        }

        body.light-theme .node {
            background: linear-gradient(135deg, #f5f5dc 0%, #e8dcc0 100%);
            box-shadow: 0 12px 32px rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.5);
        }

        .node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .node:hover {
            transform: scale(1.08);
            box-shadow: 0 16px 40px rgba(0,0,0,0.9), inset 0 2px 0 rgba(255,255,255,0.1);
            z-index: 100;
        }

        body.light-theme .node:hover {
            box-shadow: 0 16px 40px rgba(0,0,0,0.4), inset 0 2px 0 rgba(255,255,255,0.5);
        }

        .node.alive {
            border-color: #29bd29;
            box-shadow: 0 12px 32px rgba(0,0,0,0.8), 0 0 30px rgba(34, 139, 34, 0.5);
        }

        .node.deceased {
            border-color: #f30101;
            box-shadow: 0 12px 32px rgba(0,0,0,0.8), 0 0 30px rgba(139, 69, 19, 0.4);
        }

        .node-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #888;
            margin: 0 auto 16px;
            overflow: hidden;
            border: 4px solid #8b4513;
            box-shadow: 0 6px 16px rgba(0,0,0,0.6), inset 0 2px 4px rgba(0,0,0,0.4);
        }

        body.light-theme .node-avatar {
            background: linear-gradient(135deg, #8b7355 0%, #6b5943 100%);
            color: #f5f5dc;
        }

        .node-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .node-name {
            font-size: 20px;
            font-weight: bold;
            color: #ff4747;
            margin-bottom: 8px;
            word-wrap: break-word;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        body.light-theme .node-name {
            color: #2d1810;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .node-meta {
            font-size: 14px;
            color: #78c9ff;
            margin-bottom: 8px;
            text-align: center;
            font-style: italic;
        }

        body.light-theme .node-meta {
            color: #4a3520;
        }

        .node-notes {
            font-size: 13px;
            color: #bcbaba;
            margin-bottom: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        body.light-theme .node-notes {
            color: #5a4530;
        }

        .node-actions {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            justify-content: center;
        }

        .chip {
            padding: 5px 7px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
        }

        .chip:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
        }

        .chip:active {
            transform: scale(1.05);
        }

        .chip-edit {
            background: linear-gradient(135deg, #4169e1 0%, #2e4d9e 100%);
            color: white;
            border-color: #5a7fe1;
        }

        .chip-link {
            background: linear-gradient(135deg, #228b22 0%, #1a6b1a 100%);
            color: white;
            border-color: #2fa02f;
        }

        .chip-unlink {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #2d1810;
            border-color: #f4d03f;
        }

        .chip-delete {
            background: linear-gradient(135deg, #8b2500 0%, #6b1d00 100%);
            color: white;
            border-color: #a03000;
        }

        #hoverCard {
            position: fixed;
            width: 300px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.9), 0 0 0 3px #8b4513;
            padding: 20px;
            display: none;
            z-index: 9999;
            pointer-events: none;
            border: 4px solid #8b4513;
        }

        body.light-theme #hoverCard {
            background: linear-gradient(135deg, #f5f5dc 0%, #e8dcc0 100%);
        }

        .hover-content {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .hover-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            flex-shrink: 0;
            overflow: hidden;
            border: 3px solid #8b4513;
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }

        body.light-theme .hover-avatar {
            background: linear-gradient(135deg, #8b7355 0%, #6b5943 100%);
        }

        .hover-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hover-info {
            flex: 1;
        }

        .hover-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #d4af37;
        }

        body.light-theme .hover-name {
            color: #2d1810;
        }

        .hover-meta {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 4px;
            font-style: italic;
        }

        body.light-theme .hover-meta {
            color: #4a3520;
        }

        .hover-notes {
            font-size: 13px;
            color: #888;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #333;
        }

        body.light-theme .hover-notes {
            color: #5a4530;
            border-top: 2px solid #c9b896;
        }

        #inspector {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 380px;
            max-height: calc(100vh - 120px);
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.9), 0 0 0 3px #8b4513;
            padding: 28px;
            display: none;
            z-index: 1001;
            overflow-y: auto;
            border: 4px solid #8b4513;
        }

        body.light-theme #inspector {
            background: linear-gradient(135deg, #f5f5dc 0%, #e8dcc0 100%);
        }

        #inspector::-webkit-scrollbar {
            width: 10px;
        }

        #inspector::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 5px;
        }

        body.light-theme #inspector::-webkit-scrollbar-track {
            background: #d4c5a9;
        }

        #inspector::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 5px;
        }

        #inspector h3 {
            margin-bottom: 24px;
            color: #d4af37;
            font-size: 26px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            border-bottom: 3px solid #8b4513;
            padding-bottom: 12px;
        }

        body.light-theme #inspector h3 {
            color: #2d1810;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 15px;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        body.light-theme .form-group label {
            color: #2d1810;
            text-shadow: none;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #8b4513;
            border-radius: 8px;
            font-size: 14px;
            font-family: Georgia, serif;
            background: rgba(0,0,0,0.5);
            color: #d4af37;
            transition: all 0.3s;
        }

        body.light-theme .form-group input,
        body.light-theme .form-group select,
        body.light-theme .form-group textarea {
            background: rgba(255,255,255,0.9);
            color: #2d1810;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #228b22;
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.5);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
            /*          ------------------------------------------- */
        .links-list {
            margin: 24px 0;
            padding: 16px;
            background: rgba(139, 69, 19, 0.2);
            border-radius: 12px;
            border: 3px solid #8b4513;
        }

        .links-list h4 {
            color: #d4af37;
            margin-bottom: 12px;
            font-size: 16px;
        }

        body.light-theme .links-list h4 {
            color: #2d1810;
        }

        .link-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            border: 2px solid #333;
            color: #aaa;
        }

        body.light-theme .link-item {
            background: rgba(255,255,255,0.7);
            border: 2px solid #d4c5a9;
            color: #2d1810;
        }

        .link-item button {
            padding: 6px 14px;
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #2d1810;
            border: 2px solid #f4d03f;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .link-item button:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.6);
        }

        .inspector-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .inspector-buttons button {
            flex: 1;
        }

        .link-path {
            fill: none;
            stroke-width: 4;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.5));
        }

        .link-parent {
            stroke: #8b4513;
        }

        .link-spouse {
            stroke: #228b22;
            stroke-dasharray: 8, 5;
        }

        #linkingIndicator {
            position: fixed;
            top: 95px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #2d1810;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: bold;
            display: none;
            z-index: 1002;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6), 0 0 30px rgba(212, 175, 55, 0.5);
            border: 3px solid #f4d03f;
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        .node::after {
            content: 'üçÇ';
            position: absolute;
            top: -18px;
            right: -18px;
            font-size: 24px;
            opacity: 0.4;
        }

        #treeWidget {
          position: fixed;
          top: 90px;
          left: 1300px;
          background: rgba(0, 0, 0, 0.55);
          color: #fff;
          font-family: 'Georgia', serif;
          font-size: 13px;
          padding: 10px 14px;
          border-radius: 10px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.5);
          z-index: 2000;
          backdrop-filter: blur(6px);
          border: 1.5px solid rgba(212,175,55,0.6);
          line-height: 1.4em;
          transition: opacity 0.5s ease-in-out;
        }

        .light-theme #treeWidget {
          background: rgba(255, 255, 255, 0.7);
          color: #222;
          border-color: rgba(139,69,19,0.5);
        }

        #clockLabel {
          font-weight: bold;
          margin-top: 4px;
          text-align: left;
        }

    </style>
</head>
<body>
    <div id="toolbar">
        <div class="toolbar-brand">
            <div class="toolbar-icon">üå≥</div>
            <div class="toolbar-title">Family Tree</div>
        </div>

        <div id="treeClock" class="tree-clock"></div>

        <div id="treeWidget">
          <div id="createdLabel">üå± Created on Nov 11, 2025</div>
          <div id="clockLabel">üïí 12:45:32 PM</div>
        </div>


        
        <div class="toolbar-section">
            <button class="btn btn-primary" onclick="app.addNode()">+ Add Person</button>
            <button class="btn btn-secondary" id="linkModeBtn" onclick="app.toggleLinkMode()">Link Mode</button>
        </div>

        <div class="toolbar-section">
            <div class="theme-selector">
                <label>Background</label>
                <select id="bgSelect" onchange="app.changeBackground(this.value)">
                    <option value="forest">üå≤ Forest</option>
                    <option value="autumn">üçÇ Autumn</option>
                    <option value="dawn">üåÖ Dawn</option>
                    <option value="midnight">üåô Midnight</option>
                </select>
            </div>

            <div class="theme-selector">
                <label>Theme</label>
                <select id="themeSelect" onchange="app.changeTheme(this.value)">
                    <option value="dark">üåë Dark</option>
                    <option value="light">‚òÄÔ∏è Light</option>
                </select>
            </div>
        </div>

        <div class="toolbar-section">
            <div class="zoom-controls">
                <label>Zoom</label>
                <div class="zoom-buttons">
                    <button class="zoom-btn" onclick="app.zoomOut()">‚àí</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="app.zoomIn()">+</button>
                </div>
            </div>
        </div>

        <div class="toolbar-section">
            <button class="btn btn-secondary" onclick="app.exportData()">üíæ Export</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üìÇ Import</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="app.importData(event)">
        </div>
    </div>

    <div id="linkingIndicator">üîó Click a person to create connection...</div>

    <div id="workspace">
        <div id="canvasWrapper">
            <div id="canvas">
                <svg id="linksSvg"></svg>
            </div>
        </div>
    </div>

    <div id="hoverCard">
        <div class="hover-content">
            <div class="hover-avatar" id="hoverAvatar">No Image</div>
            <div class="hover-info">
                <div class="hover-name" id="hoverName"></div>
                <div class="hover-meta" id="hoverMeta"></div>
            </div>
        </div>
        <div class="hover-notes" id="hoverNotes"></div>
    </div>

    <div id="inspector">
        <h3>‚úèÔ∏è Edit Person</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="inspName">
        </div>
        <div class="form-group">
            <label>Gender</label>
            <select id="inspGender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="form-group">
            <label>Status</label>
            <select id="inspStatus">
                <option value="alive">Alive</option>
                <option value="deceased">Deceased</option>
            </select>
        </div>
        <div class="form-group">
            <label>Age</label>
            <input type="number" id="inspAge" min="0">
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea id="inspNotes"></textarea>
        </div>
        <div class="form-group">
            <label>Avatar</label>
            <input type="file" id="inspAvatar" accept="image/*">
        </div>
        <div class="form-group">
            <label>Link Style</label>
            <select id="inspLinkStyle">
                <option value="curved">Curved</option>
                <option value="classic">Classic</option>
                <option value="straight">Straight</option>
            </select>
        </div>
        <div class="links-list" id="linksList"></div>
        <div class="inspector-buttons">
            <button class="btn btn-primary" onclick="app.saveInspector()">‚úì Done</button>
            <button class="btn btn-danger" onclick="app.deleteCurrentNode()">üóë Delete</button>
        </div>
    </div>

    <script>
        const app = {
            nodes: [],
            links: [],
            draggedNode: null,
            linkingMode: false,
            linkingFrom: null,
            currentNode: null,
            nextId: 1,
            zoom: 1,
            isPanning: false,
            panStart: {x: 0, y: 0},
            panOffset: {x: 0, y: 0},

            init() {
                this.loadData();
                this.render();
                this.setupEventListeners();
                this.startAutoSave();
            },
            startClock() {
            const clockEl = document.getElementById('treeClock');
            const updateClock = () => {
                const now = new Date();
                const options = { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                clockEl.textContent = now.toLocaleString('en-US', options);
            };
            updateClock();
            setInterval(updateClock, 1000);
        },init() {
    this.loadData();
    this.render();
    this.setupEventListeners();
    this.startAutoSave();
    this.startClock(); // üïí Start the clock
},



            setupEventListeners() {
                const workspace = document.getElementById('workspace');
                const canvas = document.getElementById('canvas');
                
                workspace.addEventListener('wheel', this.onWheel.bind(this), {passive: false});
                
                workspace.addEventListener('mousedown', (e) => {
                    if (e.target === workspace || e.target === document.getElementById('canvasWrapper') || e.target === canvas) {
                        this.isPanning = true;
                        workspace.classList.add('panning');
                        this.panStart = {x: e.clientX - this.panOffset.x, y: e.clientY - this.panOffset.y};
                    }
                });
                
                workspace.addEventListener('mousemove', (e) => {
                    if (this.isPanning) {
                        this.panOffset.x = e.clientX - this.panStart.x;
                        this.panOffset.y = e.clientY - this.panStart.y;
                        this.updateTransform();
                    }
                });
                
                workspace.addEventListener('mouseup', () => {
                    this.isPanning = false;
                    workspace.classList.remove('panning');
                });

                workspace.addEventListener('mouseleave', () => {
                    this.isPanning = false;
                    workspace.classList.remove('panning');
                });

                canvas.addEventListener('mousedown', this.onNodeMouseDown.bind(this));
                document.addEventListener('mousemove', this.onNodeMouseMove.bind(this));
                document.addEventListener('mouseup', this.onNodeMouseUp.bind(this));
            },

            onWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                this.zoom = Math.min(Math.max(0.3, this.zoom + delta), 3);
                this.updateTransform();
                document.getElementById('zoomLevel').textContent = Math.round(this.zoom * 100) + '%';
            },

            zoomIn() {
                this.zoom = Math.min(3, this.zoom + 0.2);
                this.updateTransform();
                document.getElementById('zoomLevel').textContent = Math.round(this.zoom * 100) + '%';
            },

            zoomOut() {
                this.zoom = Math.max(0.3, this.zoom - 0.2);
                this.updateTransform();
                document.getElementById('zoomLevel').textContent = Math.round(this.zoom * 100) + '%';
            },

            updateTransform() {
                const wrapper = document.getElementById('canvasWrapper');
                wrapper.style.transform = `scale(${this.zoom}) translate(${this.panOffset.x / this.zoom}px, ${this.panOffset.y / this.zoom}px)`;
            },

            changeBackground(value) {
                const canvas = document.getElementById('canvas');
                if (value === 'forest') {
                    canvas.style.background = 'linear-gradient(180deg, #072012 0%, #0b3a1f 40%, #062816 100%)';
                } else if (value === 'autumn') {
                    canvas.style.background = 'linear-gradient(180deg, #2b0b00 0%, #7a2f05 40%, #f3c47a 100%)';
                } else if (value === 'dawn') {
                    canvas.style.background = 'linear-gradient(180deg, #0b3a59, #6ec1e4 40%, #fbe8a6)';
                } else if (value === 'midnight') {
                    canvas.style.background = 'linear-gradient(180deg, #000000 0%, #1a1a2e 40%, #16213e 100%)';
                }
            },

            changeTheme(value) {
                if (value === 'light') {
                    document.body.classList.add('light-theme');
                } else {
                    document.body.classList.remove('light-theme');
                }
            },

            addNode() {
                const node = {
                    id: 'node_' + this.nextId++,
                    name: 'New Person',
                    gender: 'male',
                    alive: true,
                    age: 30,
                    notes: '',
                    img: null,
                    linkStyle: 'curved',
                    x: 400 + Math.random() * 600,
                    y: 300 + Math.random() * 400
                };
                this.nodes.push(node);
                this.render();
                this.saveData();
            },

            render() {
                const canvas = document.getElementById('canvas');
                const existingNodes = canvas.querySelectorAll('.node');
                existingNodes.forEach(n => n.remove());

                this.nodes.forEach(node => {
                    const div = document.createElement('div');
                    div.className = `node ${node.alive ? 'alive' : 'deceased'}`;
                    div.style.left = node.x + 'px';
                    div.style.top = node.y + 'px';
                    div.dataset.id = node.id;

                    const avatar = document.createElement('div');
                    avatar.className = 'node-avatar';
                    if (node.img) {
                        const img = document.createElement('img');
                        img.src = node.img;
                        avatar.appendChild(img);
                    } else {
                        avatar.textContent = 'No Image';
                    }

                    const name = document.createElement('div');
                    name.className = 'node-name';
                    name.textContent = node.name;

                    const meta = document.createElement('div');
                    meta.className = 'node-meta';
                    meta.textContent = `${node.gender} ‚Ä¢ ${node.alive ? 'Alive' : 'Deceased'}`;

                    const notes = document.createElement('div');
                    notes.className = 'node-notes';
                    notes.textContent = node.notes || 'No notes';

                    const actions = document.createElement('div');
                    actions.className = 'node-actions';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'chip chip-edit';
                    editBtn.textContent = '‚úèÔ∏è Edit';
                    editBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.openInspector(node.id);
                    };

                    const linkBtn = document.createElement('button');
                    linkBtn.className = 'chip chip-link';
                    linkBtn.textContent = 'üîó Link';
                    linkBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.startLinking(node.id);
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'chip chip-delete';
                    deleteBtn.textContent = 'üóë Delete';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.deleteNode(node.id);
                    };

                    actions.appendChild(editBtn);
                    actions.appendChild(linkBtn);
                    actions.appendChild(deleteBtn);

                    div.appendChild(avatar);
                    div.appendChild(name);
                    div.appendChild(meta);
                    div.appendChild(notes);
                    div.appendChild(actions);

                    div.addEventListener('mouseenter', (e) => this.showHoverCard(node, e));
                    div.addEventListener('mouseleave', () => this.hideHoverCard());
                    div.addEventListener('mousemove', (e) => this.updateHoverCardPosition(e));

                    canvas.appendChild(div);
                });

                this.renderLinks();
            },

            renderLinks() {
                const svg = document.getElementById('linksSvg');
                svg.innerHTML = '';

                this.links.forEach(link => {
                    const fromNode = this.nodes.find(n => n.id === link.from);
                    const toNode = this.nodes.find(n => n.id === link.to);
                    if (!fromNode || !toNode) return;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = this.calculatePath(fromNode, toNode, link.type);
                    path.setAttribute('d', pathData);
                    path.classList.add('link-path');
                    path.classList.add(link.type === 'spouse' ? 'link-spouse' : 'link-parent');
                    svg.appendChild(path);
                });
            },

            calculatePath(from, to, type) {
                const x1 = from.x + 120;
                const y1 = from.y + 80;
                const x2 = to.x + 120;
                const y2 = to.y + 80;

                if (type === 'spouse') {
                    const cy = (y1 + y2) / 2;
                    return `M ${x1} ${y1} Q ${(x1+x2)/2} ${cy-30} ${x2} ${y2}`;
                } else {
                    const style = from.linkStyle || 'curved';
                    if (style === 'straight') {
                        return `M ${x1} ${y1} L ${x2} ${y2}`;
                    } else if (style === 'classic') {
                        const midY = (y1 + y2) / 2;
                        return `M ${x1} ${y1} L ${x1} ${midY} L ${x2} ${midY} L ${x2} ${y2}`;
                    } else {
                        return `M ${x1} ${y1} Q ${x1} ${(y1+y2)/2} ${x2} ${y2}`;
                    }
                }
            },

            onNodeMouseDown(e) {
                const nodeEl = e.target.closest('.node');
                if (!nodeEl) return;

                e.stopPropagation();
                const nodeId = nodeEl.dataset.id;

                if (this.linkingMode && this.linkingFrom) {
                    this.completeLinking(nodeId);
                    return;
                }

                this.draggedNode = this.nodes.find(n => n.id === nodeId);
                const rect = nodeEl.getBoundingClientRect();
                const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                
                this.dragOffset = {
                    x: (e.clientX - canvasRect.left) / this.zoom - this.draggedNode.x,
                    y: (e.clientY - canvasRect.top) / this.zoom - this.draggedNode.y
                };
            },

            onNodeMouseMove(e) {
                if (this.draggedNode) {
                    const canvasRect = document.getElementById('canvas').getBoundingClientRect();
                    this.draggedNode.x = (e.clientX - canvasRect.left) / this.zoom - this.dragOffset.x;
                    this.draggedNode.y = (e.clientY - canvasRect.top) / this.zoom - this.dragOffset.y;
                    this.render();
                }
            },

            onNodeMouseUp() {
                if (this.draggedNode) {
                    this.saveData();
                }
                this.draggedNode = null;
            },

            startLinking(nodeId) {
                this.linkingMode = true;
                this.linkingFrom = nodeId;
                document.getElementById('linkModeBtn').classList.add('active');
                document.getElementById('linkingIndicator').style.display = 'block';
            },

            completeLinking(toId) {
                if (this.linkingFrom === toId) {
                    alert('Cannot link a person to themselves');
                    return;
                }

                const linkType = prompt('Link type:\n1 = Parent/Child\n2 = Spouse', '1');
                if (!linkType) {
                    this.linkingMode = false;
                    this.linkingFrom = null;
                    document.getElementById('linkModeBtn').classList.remove('active');
                    document.getElementById('linkingIndicator').style.display = 'none';
                    return;
                }

                if (linkType === '1') {
                    const direction = prompt('Is ' + this.nodes.find(n => n.id === this.linkingFrom).name + ' the:\n1 = Parent\n2 = Child', '1');
                    if (direction === '1') {
                        this.addLink(this.linkingFrom, toId, 'parent');
                    } else if (direction === '2') {
                        this.addLink(toId, this.linkingFrom, 'parent');
                    }
                } else if (linkType === '2') {
                    this.addLink(this.linkingFrom, toId, 'spouse');
                }

                this.linkingMode = false;
                this.linkingFrom = null;
                document.getElementById('linkModeBtn').classList.remove('active');
                document.getElementById('linkingIndicator').style.display = 'none';
                this.render();
                this.saveData();
            },

            toggleLinkMode() {
                if (this.linkingMode) {
                    this.linkingMode = false;
                    this.linkingFrom = null;
                    document.getElementById('linkModeBtn').classList.remove('active');
                    document.getElementById('linkingIndicator').style.display = 'none';
                }
            },

            addLink(from, to, type) {
                const link = {
                    id: 'link_' + Date.now(),
                    from: from,
                    to: to,
                    type: type
                };
                this.links.push(link);
            },

            openInspector(nodeId) {
                this.currentNode = this.nodes.find(n => n.id === nodeId);
                if (!this.currentNode) return;

                document.getElementById('inspName').value = this.currentNode.name;
                document.getElementById('inspGender').value = this.currentNode.gender;
                document.getElementById('inspStatus').value = this.currentNode.alive ? 'alive' : 'deceased';
                document.getElementById('inspAge').value = this.currentNode.age;
                document.getElementById('inspNotes').value = this.currentNode.notes;
                document.getElementById('inspLinkStyle').value = this.currentNode.linkStyle;

                this.renderLinksInInspector();

                document.getElementById('inspector').style.display = 'block';
            },

            renderLinksInInspector() {
                const container = document.getElementById('linksList');
                container.innerHTML = '<h4>üîó Connections:</h4>';

                const nodeLinks = this.links.filter(l => 
                    l.from === this.currentNode.id || l.to === this.currentNode.id
                );

                if (nodeLinks.length === 0) {
                    container.innerHTML += '<div style="font-size:13px; color:#888; text-align:center; padding:12px">No connections yet</div>';
                    return;
                }

                nodeLinks.forEach(link => {
                    const other = link.from === this.currentNode.id ? 
                        this.nodes.find(n => n.id === link.to) :
                        this.nodes.find(n => n.id === link.from);
                    
                    if (!other) return;

                    const item = document.createElement('div');
                    item.className = 'link-item';

                    const label = document.createElement('span');
                    let relationship = '';
                    if (link.type === 'spouse') {
                        relationship = 'üíë Spouse of ';
                    } else if (link.from === this.currentNode.id) {
                        relationship = 'üë∂ Parent of ';
                    } else {
                        relationship = 'üë¥ Child of ';
                    }
                    label.textContent = relationship + other.name;

                    const btn = document.createElement('button');
                    btn.textContent = 'Unlink';
                    btn.onclick = () => this.removeLink(link.id);

                    item.appendChild(label);
                    item.appendChild(btn);
                    container.appendChild(item);
                });
            },

            removeLink(linkId) {
                this.links = this.links.filter(l => l.id !== linkId);
                this.render();
                this.renderLinksInInspector();
                this.saveData();
            },

            saveInspector() {
                this.currentNode.name = document.getElementById('inspName').value;
                this.currentNode.gender = document.getElementById('inspGender').value;
                this.currentNode.alive = document.getElementById('inspStatus').value === 'alive';
                this.currentNode.age = parseInt(document.getElementById('inspAge').value);
                this.currentNode.notes = document.getElementById('inspNotes').value;
                this.currentNode.linkStyle = document.getElementById('inspLinkStyle').value;

                const avatarFile = document.getElementById('inspAvatar').files[0];
                if (avatarFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentNode.img = e.target.result;
                        this.render();
                        this.saveData();
                    };
                    reader.readAsDataURL(avatarFile);
                }

                document.getElementById('inspector').style.display = 'none';
                this.render();
                this.saveData();
            },

            deleteCurrentNode() {
                if (!confirm('Delete this person from the family tree?')) return;
                this.deleteNode(this.currentNode.id);
                document.getElementById('inspector').style.display = 'none';
            },

            deleteNode(nodeId) {
                this.nodes = this.nodes.filter(n => n.id !== nodeId);
                this.links = this.links.filter(l => l.from !== nodeId && l.to !== nodeId);
                this.render();
                this.saveData();
            },

            showHoverCard(node, e) {
                const card = document.getElementById('hoverCard');
                const avatar = document.getElementById('hoverAvatar');
                
                if (node.img) {
                    avatar.innerHTML = `<img src="${node.img}">`;
                } else {
                    avatar.innerHTML = 'No Image';
                }

                document.getElementById('hoverName').textContent = node.name;
                document.getElementById('hoverMeta').textContent = 
                    `${node.gender} ‚Ä¢ ${node.alive ? 'Alive' : 'Deceased'} ‚Ä¢ Age: ${node.age}`;
                document.getElementById('hoverNotes').textContent = node.notes || 'No notes';

                card.style.display = 'block';
                this.updateHoverCardPosition(e);
            },

            hideHoverCard() {
                document.getElementById('hoverCard').style.display = 'none';
            },

            updateHoverCardPosition(e) {
                const card = document.getElementById('hoverCard');
                card.style.left = (e.clientX + 15) + 'px';
                card.style.top = (e.clientY + 15) + 'px';
            },

            saveData() {
                const data = {
                    nodes: this.nodes,
                    links: this.links,
                    nextId: this.nextId
                };
                localStorage.setItem('familyTreeData', JSON.stringify(data));
            },

            loadData() {
                const saved = localStorage.getItem('familyTreeData');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.nodes = data.nodes || [];
                    this.links = data.links || [];
                    this.nextId = data.nextId || 1;
                }
            },

            exportData() {
                const data = {
                    nodes: this.nodes,
                    links: this.links
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'family-tree-' + Date.now() + '.json';
                a.click();
            },

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        this.nodes = data.nodes || [];
                        this.links = data.links || [];
                        this.render();
                        this.saveData();
                        alert('Family tree imported successfully! üå≥');
                    } catch (err) {
                        alert('Error importing file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            },

            startAutoSave() {
                setInterval(() => {
                    this.saveData();
                }, 300000);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        
    </script>
</body>
</html>